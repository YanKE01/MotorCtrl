/* --------------------------- (C) COPYRIGHT 2020 Fortiortech ShenZhen -----------------------------
    File Name      : TimerInit.c
    Author         : Fortiortech  Appliction Team
    Version        : V1.0
    Date           : 2020-09-30
    Description    : This file contains Timer Initial function used for Motor Control.
----------------------------------------------------------------------------------------------------  
                                       All Rights Reserved
------------------------------------------------------------------------------------------------- */
/* Includes -------------------------------------------------------------------------------------*/
#include <FU68xx_2.h>
#include <Myproject.h>

/* -------------------------------------------------------------------------------------------------
    Function Name  : TIM3_Init
    Description    : TIM3初始化配置
    Date           : 2020-09-30
    Parameter      : None
------------------------------------------------------------------------------------------------- */
void TIM3_Init(void)
{
/*-------------------------------------------------------------------------------------------------
  先停止计数，配置完寄存器后，最后启动计数
-------------------------------------------------------------------------------------------------*/
	ClrBit(TIM3_CR1, T3EN);			                                                               // 0-停止计数；1-使能计数
	SetBit(PH_SEL, T3SEL);				                                                           // 0-不连接到端口GP11；1-连接到端口GP11
/*-------------------------------------------------------------------------------------------------
	时钟分频设置(T2PSC)
  000:cpuclk(24MHz)			001:cpuclk/2^1(12MHz)	010:cpuclk/2^2(6MHz)	011:cpuclk/2^3(3MHz)
  100:cpuclk/2^4(1.5MHz)	101:cpuclk/2^5(750KHz)	110:cpuclk/2^6(375KHz)	111:cpuclk/2^7(187.5KHz)
-------------------------------------------------------------------------------------------------*/
	SetReg(TIM3_CR0, T3PSC0 | T3PSC1 | T3PSC2, 0x00);

/*-------------------------------------------------------------------------------------------------
	/模式选择
	0-输入模式
  1-输出模式
-------------------------------------------------------------------------------------------------*/
    SetBit(TIM3_CR0, T3MOD);	

    ClrBit(TIM3_CR0, T3OCM);	
  
/*-------------------------------------------------------------------------------------------------
	/滤波时间
	00-不滤波；01-8个时钟周期
  10-16个时钟周期；11-32个时钟周期
-------------------------------------------------------------------------------------------------*/
	SetReg(TIM3_CR1, T3FE1|T3FE0,T3FE0);				                       
/*-------------------------------------------------------------------------------------------------
  清除中断标志位
	禁止PWM周期检测中断使能
	使能计数器上溢中断使能
-------------------------------------------------------------------------------------------------*/
	ClrBit(TIM3_CR1, T3IR | T3IF | T3IP);		                                                   // 清除中断标志位
	SetBit(TIM3_CR1, T3IPE | T3IFE);				                                               // 输入有效边沿变化中断使能和基本计数器上溢使能
/*-------------------------------------------------------------------------------------------------
	定时器2中断优先级配置及芯片中断总使能
	PTIM31-PTIM30，中断优先级控制值从0-3依次表示优先级从最低到最高，共4级优化级控制
	EA,芯片中断总使能
-------------------------------------------------------------------------------------------------*/
//	PTIM31 = 0;
//	PTIM30 = 1;										                                               // TIM2/3中断优先级别为2
//	EA = 1;

/*-------------------------------------------------------------------------------------------------
  配置周期值、比较值、计数值
-------------------------------------------------------------------------------------------------*/
	TIM3__CNTR = 0;
//    TIM3__DR = 0;	
    TIM3__ARR = 480;
   TIM3__DR=320;
/*-----------启动计数------------------------------------------------*/
	SetBit(TIM3_CR1, T3EN);				                                                           //使能计数器，启动计数
}

/* -------------------------------------------------------------------------------------------------
    Function Name  : TIM1ms_Init
    Description    : TIM1MS初始化配置
    Date           : 2020-09-30
    Parameter      : None
------------------------------------------------------------------------------------------------- */
void TIM1ms_Init(void)
{
	PTIM4S1 = 0;
	PTIM4S0 = 1;										                                           // TIM4/5中断优先级别为1
	EA = 1;
	SetBit(DRV_SR, SYSTIE);		                                                               // 使能1ms定时中断
}
