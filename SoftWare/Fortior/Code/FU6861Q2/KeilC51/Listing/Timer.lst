C51 COMPILER V9.52.0.0   TIMER                                                             04/01/2023 22:13:44 PAGE 1   


C51 COMPILER V9.52.0.0, COMPILATION OF MODULE TIMER
OBJECT MODULE PLACED IN .\Output\Timer.obj
COMPILER INVOKED BY: D:\IDE\keil\C51\BIN\C51.EXE ..\User\Source\Hardware\Timer.c LARGE OMF2 WARNINGLEVEL(0) BROWSE INCDI
                    -R(..\User\Include;..\FU68xx_Hardware_Driver\Include) DEBUG PRINT(.\Listing\Timer.lst) TABS(2) OBJECT(.\Output\Timer.obj)

line level    source

   1          /**
   2           * @copyright (C) COPYRIGHT 2022 Fortiortech Shenzhen
   3           * @file      TimerInit.c
   4           * @author    Fortiortech  Appliction Team
   5           * @since     Create:2021-05-14
   6           * @date      Last modify:2022-07-14
   7           * @brief     This file contains Timer Initial function used for Motor Control.
   8           */ 
   9              
  10          #include <FU68xx_2.h>
  11          #include <Myproject.h>
  12          
  13          /**
  14           * @brief      TIM0初始化配置
  15           */
  16          void TIM0_Init(void)
  17          {
  18   1      }
  19          
  20          /**
  21           * @brief      TIM1初始化配置
  22           */
  23          void TIM1_Init(void)
  24          {
  25   1      }
  26          
  27          /**
  28           * @brief      TIM2初始化配置
  29           */
  30          void TIM2_Init(void)
  31          {
  32   1      }
  33          
  34          /**
  35           * @brief      TIM3初始化配置
  36           */
  37          void TIM3_Init(void)
  38          {
  39   1          /*  -------------------------------------------------------------------------------------------------
  40   1              先停止计数，配置完寄存器后，最后启动计数
  41   1              -------------------------------------------------------------------------------------------------*
             -/
  42   1          ClrBit(TIM3_CR1, T3EN);                                         // 0-停止计数；1-使能计数
  43   1            SetBit(PH_SEL, T3SEL);                                            //0-不连接到端口GP11；1-连
             -接到端口GP11
  44   1      //    ClrBit(PH_SEL, T3SEL);
  45   1          /*  -------------------------------------------------------------------------------------------------
  46   1              1、时钟分频设置(T2PSC)
  47   1              2、000:cpuclk(24MHz)             001:cpuclk/2^1(12MHz)   010:cpuclk/2^2(6MHz)    011:cpuclk/2^3(3
             -MHz)
  48   1              3、100:cpuclk/2^4(1.5MHz)  101:cpuclk/2^5(750KHz)  110:cpuclk/2^6(375KHz)  111:cpuclk/2^7(187.5KH
             -z)
  49   1              -------------------------------------------------------------------------------------------------*
             -/
C51 COMPILER V9.52.0.0   TIMER                                                             04/01/2023 22:13:44 PAGE 2   

  50   1          SetReg(TIM3_CR0, T3PSC0 | T3PSC1 | T3PSC2, 0 );
  51   1          /*  -------------------------------------------------------------------------------------------------
  52   1              1、模式选择
  53   1              2、0-输入模式
  54   1              3、1-输出模式
  55   1              -------------------------------------------------------------------------------------------------*
             -/
  56   1          ClrBit(TIM3_CR0, T3MOD);
  57   1          ClrBit(TIM3_CR0, T3OCM);
  58   1          /*  -------------------------------------------------------------------------------------------------
  59   1              1、滤波时间
  60   1              2、T3FE1/T3FE0 = 00-不滤波；            T3FE1/T3FE0 = 01-8个时钟周期
  61   1              3、T3FE1/T3FE0 = 10-16个时钟周期；T3FE1/T3FE0 = 11-32个时钟周期
  62   1              -------------------------------------------------------------------------------------------------*
             -/
  63   1          SetReg(TIM3_CR1, T3FE1 | T3FE0, T3FE0);
  64   1          /*  -------------------------------------------------------------------------------------------------
  65   1              1、清除中断标志位
  66   1              2、禁止PWM周期检测中断使能
  67   1              3、使能计数器上溢中断使能
  68   1              -------------------------------------------------------------------------------------------------*
             -/
  69   1          ClrBit(TIM3_CR1, T3IR | T3IF | T3IP);                           // 清除中断标志位
  70   1          SetBit(TIM3_CR1, T3IPE | T3IFE);                                // 输入有效边沿变化中断使
             -和基本计数器上溢使能
  71   1          /*  -------------------------------------------------------------------------------------------------
  72   1              1、定时器2中断优先级配置及芯片中断总使能
  73   1              2、PTIM31-PTIM30，中断优先级控制值从0-3依次表示优先级从最低到最高，共4
             -优化级控制
  74   1              3、EA,芯片中断总使能
  75   1              -------------------------------------------------------------------------------------------------*
             -/
  76   1          PTIM31 = 0;
  77   1          PTIM30 = 1;                                                     // TIM2/3中断优先级别为2
  78   1          EA = 1;
  79   1          /*  -------------------------------------------------------------------------------------------------
  80   1              配置周期值、比较值、计数值
  81   1              -------------------------------------------------------------------------------------------------*
             -/
  82   1          TIM3__CNTR = 0;
  83   1          TIM3__DR = 0;
  84   1          TIM3__ARR = 24000;
  85   1          /*-----------启动计数------------------------------------------------*/
  86   1          SetBit(TIM3_CR1, T3EN);                                         //使能计数器，启动计数
  87   1      }
  88          
  89          /**
  90           * @brief      TIM4初始化配置
  91           */
  92          void TIM4_Init(void)
  93          {
  94   1          /*  -------------------------------------------------------------------------------------------------
  95   1              先停止计数，配置完寄存器后，最后启动计数
  96   1              -------------------------------------------------------------------------------------------------*
             -/
  97   1          ClrBit(TIM4_CR1, T4EN);                                         // 0 - 停止计数；1 - 使能计数
  98   1          SetBit(PH_SEL, T4SEL);                                          // 1 - P0.1作为Time4的输入输出
  99   1          //    ClrBit(PH_SEL, T4SEL);                                            // 0 - P0.1作为GPIO
 100   1          /*  -------------------------------------------------------------------------------------------------
 101   1              1、时钟分频设置(T4PSC)
 102   1              2、000:cpuclk(24MHz)       001:cpuclk/2^1(12MHz)   010:cpuclk/2^2(6MHz)    011:cpuclk/2^3(3MHz)
 103   1              3、100:cpuclk/2^4(1.5MHz)  101:cpuclk/2^5(750KHz)  110:cpuclk/2^6(375KHz)  111:cpuclk/2^7(187.5KH
C51 COMPILER V9.52.0.0   TIMER                                                             04/01/2023 22:13:44 PAGE 3   

             -z)
 104   1              -------------------------------------------------------------------------------------------------*
             -/
 105   1          SetReg(TIM4_CR0, T4PSC0 | T4PSC1 | T4PSC2,  T4PSC0 );
 106   1          /*  -------------------------------------------------------------------------------------------------
 107   1              1、TIM4_CR0：   输入输出模式选择
 108   1              2、T4MOD = 0 输入Timer模式
 109   1              3、T4MOD = 1 输出模式
 110   1              -------------------------------------------------------------------------------------------------*
             -/
 111   1          SetBit(TIM4_CR0,T4MOD);
 112   1      //    ClrBit(TIM4_CR0, T4MOD);
 113   1          /*  -------------------------------------------------------------------------------------------------
 114   1              1、输出模式        ：比较模式选择
 115   1              2、T4OCM = 0      TIM4__CNTR <= TIM4__DR 输出 “0”  TIM4__CNTR > TIM4__DR 输出 “1”
 116   1              3、T4OCM = 1      TIM4__CNTR <= TIM4__DR 输出 “1”  TIM4__CNTR > TIM4__DR 输出 “0”
 117   1          
 118   1              1、输入Timer模式   ：周期沿选择
 119   1              2、T4OCM = 0      相邻两个上升沿为1个周期，上升沿到下降沿为高电平脉宽
 120   1              3、T4OCM = 1      相邻两个下降沿为1个周期，下降沿到上升沿为低电平脉宽
 121   1              -------------------------------------------------------------------------------------------------*
             -/
 122   1          //    SetBit(TIM4_CR0,T4OCM);//输出比较器匹配模式,TIM3_CNTR≤TIM3_DR: 0;
 123   1          ClrBit(TIM4_CR0, T4OCM);
 124   1          /*  -------------------------------------------------------------------------------------------------
 125   1              1、滤波时间
 126   1              2、00 - 不滤波；       01 - 8个时钟周期
 127   1              3、10 - 16个时钟周期； 11 - 32个时钟周期
 128   1              -------------------------------------------------------------------------------------------------*
             -/
 129   1          SetReg(TIM4_CR1, T4FE1 | T4FE0, T4FE1 | T4FE0);
 130   1          /*  -------------------------------------------------------------------------------------------------
 131   1              1、清除中断标志位
 132   1              2、禁止PWM周期检测中断使能
 133   1              3、使能计数器上溢中断使能
 134   1              -------------------------------------------------------------------------------------------------*
             -/
 135   1          ClrBit(TIM4_CR1, T4IR | T4IP | T4IF);                           // 清除中断标志位
 136   1          ClrBit(TIM4_CR1, T4IFE | T4IPE);                                // 输入有效边沿变化中断使
             -和基本计数器上溢使能
 137   1          ClrBit(TIM4_CR0, T4IRE);                                        // 輸出模式：比較匹配中斷
             -能  輸入模式：脈寬檢測中斷使能
 138   1          /*  -------------------------------------------------------------------------------------------------
 139   1              1、单次模式配置
 140   1              2、输出模式：计数器上溢事件
 141   1              3、输入模式：PWM周期检测或计数器上溢事件
 142   1              4、T4OPM = 0       发生上述事件时，计数器不停止
 143   1              5、T4OPM = 1       发生上述事件时，计数器停止(清除T4EN)
 144   1              -------------------------------------------------------------------------------------------------*
             -/
 145   1          ClrBit(TIM4_CR0, T4OPM);
 146   1          /*  -------------------------------------------------------------------------------------------------
 147   1              1、定时器4中断优先级配置及芯片中断总使能
 148   1              2、PTIM4S1-PTIM4S0，中断优先级控制值从0-3依次表示优先级从最低到最高，共4
             -级优化级控制
 149   1              3、EA,芯片中断总使能
 150   1              -------------------------------------------------------------------------------------------------*
             -/
 151   1          PTIM4S1 = 1;
 152   1          PTIM4S0 = 0;                                                    // TIM4中断优先级别为2
 153   1          EA = 1;
 154   1          /*  -------------------------------------------------------------------------------------------------
C51 COMPILER V9.52.0.0   TIMER                                                             04/01/2023 22:13:44 PAGE 4   

 155   1              配置周期值、比较值、计数值
 156   1              -------------------------------------------------------------------------------------------------*
             -/
 157   1          TIM4__DR   = 12000;                                             //输入模式，DR和ARR的值由硬
             -写；
 158   1          TIM4__ARR  = 24000.;
 159   1          TIM4__CNTR = 0;
 160   1          /* -----启动计数----- */
 161   1          SetBit(TIM4_CR1, T4EN);                                         //使能计数器，启动计数
 162   1      }
 163          
 164          /*  -------------------------------------------------------------------------------------------------
 165              Function Name  : TIM1ms_Init
 166              Description    : TIM1MS初始化配置
 167              Date           : 2020-08-07
 168              Parameter      : None
 169              ------------------------------------------------------------------------------------------------- */
 170          
 171          void TIM1ms_Init(void)
 172          {
 173   1          //SYST_ARR = 24000;                                             //计算公式：24M/SYST_ARR；例 24
             -M/24000=1000Hz
 174   1          PTIM4S1 = 0;
 175   1          PTIM4S0 = 1;                                                    // TIM4/5中断优先级别为1
 176   1          EA = 1;
 177   1          SetBit(DRV_SR, SYSTIE);                                         // 使能1ms定时中断
 178   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    146    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
   EDATA SIZE       =   ----    ----
   HDATA SIZE       =   ----    ----
   XDATA CONST SIZE =   ----    ----
   FAR CONST SIZE   =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
