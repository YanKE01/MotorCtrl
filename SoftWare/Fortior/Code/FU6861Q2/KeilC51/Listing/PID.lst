C51 COMPILER V9.52.0.0   PID                                                               04/01/2023 22:13:43 PAGE 1   


C51 COMPILER V9.52.0.0, COMPILATION OF MODULE PID
OBJECT MODULE PLACED IN .\Output\PID.obj
COMPILER INVOKED BY: D:\IDE\keil\C51\BIN\C51.EXE ..\User\Source\Function\PID.c LARGE OMF2 WARNINGLEVEL(0) BROWSE INCDIR(
                    -..\User\Include;..\FU68xx_Hardware_Driver\Include) DEBUG PRINT(.\Listing\PID.lst) TABS(2) OBJECT(.\Output\PID.obj)

line level    source

   1          /**
   2           * @copyright (C) COPYRIGHT 2022 Fortiortech Shenzhen
   3           * @file      PID.c
   4           * @author    Fortiortech  Appliction Team
   5           * @since     Create:2021-05-14
   6           * @date      Last modify:2022-07-14
   7           * @brief     This file contains PID function used for Motor Control
   8           */
   9          /* Includes -------------------------------------------------------------------------------------*/
  10          #include <FU68xx_2.h>
  11          #include <Myproject.h>
  12          
  13          /* Private variables ----------------------------------------------------------------------------*/
  14          
  15          //Ramp_TypeDef xdata SpeedRamp;
  16          PID_TypeDef xdata SpeedPID;
  17          PID_TypeDef xdata CurrentPID;
  18          
  19          
  20          /**
  21           * @brief      é€Ÿåº¦PIDå‚æ•°åˆå§‹åŒ–
  22           */
  23          void SpeedPIDInit(void)
  24          {
  25   1       
  26   1          SpeedPID.Kp = _Q12(0.7);
  27   1          SpeedPID.Ki = _Q12(0.01);
  28   1          SpeedPID.Err = 0;
  29   1          SpeedPID.Err_Last1 = 0;
  30   1          SpeedPID.Err_Err = 0;
  31   1          
  32   1          SpeedPID.Out = _Q15(0.99);
  33   1          SpeedPID.OutMax = _Q15(0.99);
  34   1          SpeedPID.OutMin = _Q15(0.0);
  35   1          
  36   1      }
  37          
  38          
  39          /**
  40           * @brief      ç”µæµPIDå‚æ•°åˆå§‹åŒ–
  41           */
  42          void CurrentPIDInit(void)
  43          {
  44   1          CurrentPID.Kp = 0;
  45   1          CurrentPID.Ki = 0;
  46   1          CurrentPID.Err = 0;
  47   1          CurrentPID.Err_Last1 = 0;
  48   1          CurrentPID.Err_Err = 0;
  49   1          
  50   1          CurrentPID.Out = 0;
  51   1          CurrentPID.OutMax = 0;
  52   1          CurrentPID.OutMin = 0;
  53   1      }
  54          
C51 COMPILER V9.52.0.0   PID                                                               04/01/2023 22:13:43 PAGE 2   

  55          /** 
  56           * @brief        ä¸å¸¦MDUçš„è½¯ä»¶PI
  57           * @param[in]    PID
  58           * @param[in]    Ref
  59           * @param[in]    Cur
  60           * @return       PIDè¿ç®—ç»“æžœ
  61           */
  62          int16 PIDControl(PID_TypeDef * PID, int16 Ref, int16 Cur)
  63          {
  64   1          int32 Kp_Out, Ki_Out, PID_Out;
  65   1          
  66   1          /*PIè¿ç®—æ—¶é—´67us*/
  67   1          if (!PID->Err)
  68   1          {
  69   2              PID->Err_Last1 = Ref - Cur;                                           // åˆå§‹åŒ–PIDä¸Šæ¬¡åå·®
  70   2              PID->Err = Ref - Cur;                                                 // åˆå§‹åŒ–PIDå½“å‰åå·®
  71   2              PID->Err_Err = PID->Err - PID->Err_Last1;                             // åˆå§‹åŒ–PIDä¸Šæ¬¡åå·®å
             -’Œä¸Šä¸Šæ¬¡åå·®ä¹‹å·®
  72   2          }
  73   1          else
  74   1          {
  75   2              PID->Err_Last1 = PID->Err;                                            // ä¿å­˜PIDä¸Šæ¬¡åå·®
  76   2              PID->Err = Ref - Cur;                                                 // è®¡ç®—PIDå½“å‰åå·®
  77   2              PID->Err_Err = PID->Err - PID->Err_Last1;                             // è®¡ç®—PIDä¸Šæ¬¡åå·®å’Œä
             -¸Šä¸Šæ¬¡åå·®ä¹‹å·®
  78   2          }
  79   1          
  80   1          Kp_Out = ((int32)PID->Kp * (int32)PID->Err_Err) >> 12;
  81   1          Ki_Out = ((int32)PID->Ki * (int32)PID->Err) >> 12;
  82   1          PID_Out = PID->Out;
  83   1          PID_Out += Kp_Out + Ki_Out;
  84   1          
  85   1          if (PID_Out > PID->OutMax)
  86   1          {
  87   2              PID_Out = PID->OutMax;                                                 // PIDæœ€é«˜è¾“å‡º
  88   2          }
  89   1          
  90   1          if (PID_Out < PID->OutMin)
  91   1          {
  92   2              PID_Out = PID->OutMin;                                                 // PIDæœ€ä½Žè¾“å‡º
  93   2          }
  94   1          
  95   1          PID->Out = PID_Out;
  96   1          return PID->Out;
  97   1      }
  98          
  99          
 100          /** 
 101           * @brief        å¸¦MDUçš„è½¯ä»¶PI
 102           * @param[in]    PID
 103           * @param[in]    Ref
 104           * @param[in]    Cur
 105           * @return       PIDè¿ç®—ç»“æžœ
 106           */
 107          int16 PID_Control(PID_TypeDef * PID, int16 Ref, int16 Cur)
 108          {
 109   1          int32 xdata Kp_Out;
 110   1          int32 xdata Ki_Out;
 111   1          int32 xdata PID_Out;
 112   1          
 113   1          /*PIè¿ç®—æ—¶é—´42us*/
 114   1          if (!PID->Err)
C51 COMPILER V9.52.0.0   PID                                                               04/01/2023 22:13:43 PAGE 3   

 115   1          {
 116   2              PID->Err_Last1 = Ref - Cur;                                           // åˆå§‹åŒ–PIDä¸Šæ¬¡åå·®
 117   2              PID->Err = Ref - Cur;                                                 // åˆå§‹åŒ–PIDå½“å‰åå·®
 118   2              PID->Err_Err = PID->Err - PID->Err_Last1;                             // åˆå§‹åŒ–PIDä¸Šæ¬¡åå·®å
             -’Œä¸Šä¸Šæ¬¡åå·®ä¹‹å·®
 119   2          }
 120   1          else
 121   1          {
 122   2              PID->Err_Last1 = PID->Err;                                            // ä¿å­˜PIDä¸Šæ¬¡åå·®
 123   2              PID->Err = Ref - Cur;                                                 // è®¡ç®—PIDå½“å‰åå·®
 124   2              PID->Err_Err = PID->Err - PID->Err_Last1;                             // è®¡ç®—PIDä¸Šæ¬¡åå·®å’Œä
             -¸Šä¸Šæ¬¡åå·®ä¹‹å·®
 125   2          }
 126   1          
 127   1          MDU_MUL_IDATA_U32(PID->Kp, PID->Err_Err,&Kp_Out);
 128   1          MDU_MUL_IDATA_U32(PID->Ki, PID->Err,&Ki_Out);
 129   1          
 130   1          PID_Out = PID->Out;
 131   1          PID_Out += Kp_Out + Ki_Out;
 132   1          
 133   1          if (PID_Out > PID->OutMax)
 134   1          {
 135   2              PID_Out = PID->OutMax;                                                // PIDæœ€é«˜è¾“å‡º
 136   2          }
 137   1          
 138   1          if (PID_Out < PID->OutMin)
 139   1          {
 140   2              PID_Out = PID->OutMin;                                                // PIDæœ€ä½Žè¾“å‡º
 141   2          }
 142   1          
 143   1          PID->Out = PID_Out;
 144   1          return PID->Out;
 145   1      }
 146          
 147          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   1232    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =     32      38
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
   EDATA SIZE       =   ----    ----
   HDATA SIZE       =   ----    ----
   XDATA CONST SIZE =   ----    ----
   FAR CONST SIZE   =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
