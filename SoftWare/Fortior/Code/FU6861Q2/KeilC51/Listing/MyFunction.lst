C51 COMPILER V9.52.0.0   MYFUNCTION                                                        04/01/2023 22:13:42 PAGE 1   


C51 COMPILER V9.52.0.0, COMPILATION OF MODULE MYFUNCTION
OBJECT MODULE PLACED IN .\Output\MyFunction.obj
COMPILER INVOKED BY: D:\IDE\keil\C51\BIN\C51.EXE ..\User\Source\Application\MyFunction.c LARGE OMF2 WARNINGLEVEL(0) BROW
                    -SE INCDIR(..\User\Include;..\FU68xx_Hardware_Driver\Include) DEBUG PRINT(.\Listing\MyFunction.lst) TABS(2) OBJECT(.\Outp
                    -ut\MyFunction.obj)

line level    source

   1          /*
   2           * @Author: Yanke@zjut.edu.cn
   3           * @Date: 2023-03-26 13:09:19
   4           * @LastEditors: LINKEEE 1435020085@qq.com
   5           * @LastEditTime: 2023-04-01 22:03:34
   6           * @FilePath: \Software\User\Source\Application\MyFunction.c
   7           */
   8          
   9          #include "MyFunction.h"
  10          #include "TM1650.h"
  11          #include <FU68xx_2.h>
  12          #include <Myproject.h>
  13          #include "MyVariable.h"
  14          
  15          uint8 keyValue = 0;
  16          uint8 keyValuePrev = 0;
  17          
  18          extern MCRAMP xdata mcSpeedRamp; ///< 控制指令爬坡结构体相关变量
  19          
  20          void IncreaseSpeed(); // 增速
  21          void ReduceSpeed();   // 减速
  22          void ModeUi();        // 界面刷新
  23          /**
  24           * @description: 限制转速
  25           * @param {int} *speed
  26           * @param {int} min
  27           * @param {int} max
  28           * @return {*}
  29           */
  30          static void LimitSpeed(uint16 *speed, uint16 min, uint16 max)
  31          {
  32   1          if (*speed > max)
  33   1          {
  34   2              *speed = max;
  35   2          }
  36   1      
  37   1          if (*speed < min)
  38   1          {
  39   2              *speed = min;
  40   2          }
  41   1      }
  42          
  43          /**
  44           * @description: 50Ms的任务
  45           * @return {*}
  46           */
  47          void MyTask_50Ms_Entry()
  48          {
  49   1      }
  50          
  51          /***
  52           *   KEY1:0X44    KEY2:0X45   KEY3:0X46
  53           *
C51 COMPILER V9.52.0.0   MYFUNCTION                                                        04/01/2023 22:13:42 PAGE 2   

  54           *   KEY4:0X47    KEY5:0X4C   KEY6:0X4D
  55           *
  56           */
  57          /**
  58           * @description: 100Ms的任务
  59           * @return {*}
  60           */
  61          void MyTask_100Ms_Entry()
  62          {
  63   1          uint8 i = 0;
  64   1          keyValue = ScanKey1650();
  65   1      
  66   1          if (keyValue != keyValuePrev)
  67   1          {
  68   2              switch (keyValue)
  69   2              {
  70   3              case 0x44:
  71   3                  // 启动
  72   3                  GP37 = 1;
  73   3                  motor.state = 1;
  74   3                  break;
  75   3      
  76   3              case 0x47:
  77   3                  // 停止
  78   3                  GP37 = 0;
  79   3                  motor.state = 0;
  80   3                  break;
  81   3              case 0x45:
  82   3                  // 菜单
  83   3                  break;
  84   3              case 0x4C:
  85   3                  // ACK
  86   3                  ui.isSetSpeed = 0;                         // 转速设置结束
  87   3                  motor.targetSpeed = motor.targetSpeedTemp; // 确认转速
  88   3                  break;
  89   3              case 0x46:
  90   3                  // 增速
  91   3                  IncreaseSpeed();
  92   3                  break;
  93   3              case 0x4D:
  94   3                  // 减速
  95   3                  ReduceSpeed();
  96   3                  break;
  97   3              default:
  98   3                  break;
  99   3              }
 100   2          }
 101   1      
 102   1          keyValuePrev = keyValue;
 103   1          ModeUi(); // 刷新UI
 104   1      }
 105          
 106          /**
 107           * @description: 1S的任务
 108           * @return {*}
 109           */
 110          void MyTask_1S_Entry()
 111          {
 112   1          static uint8 state = 0;
 113   1          state = !state;
 114   1          GP36 = state;
 115   1      }
C51 COMPILER V9.52.0.0   MYFUNCTION                                                        04/01/2023 22:13:42 PAGE 3   

 116          
 117          /**
 118           * @description: 函数运行在1ms的任务中
 119           * @return {*}
 120           */
 121          void MyTaskLoop(void)
 122          {
 123   1          static int count = 0;
 124   1          count++;
 125   1      
 126   1          if (count % 50 == 0)
 127   1          {
 128   2              MyTask_50Ms_Entry();
 129   2          }
 130   1      
 131   1          if (count % 100 == 0)
 132   1          {
 133   2              MyTask_100Ms_Entry();
 134   2          }
 135   1      
 136   1          if (count % 1000 == 0)
 137   1          {
 138   2              MyTask_1S_Entry();
 139   2              count = 0;
 140   2          }
 141   1      }
 142          
 143          /**
 144           * @description: 增速
 145           * @return {*}
 146           */
 147          void IncreaseSpeed()
 148          {
 149   1          if (ui.modePage == SpeedPage)
 150   1          {
 151   2              // 只允许在速度设置页设置转速
 152   2              ui.isSetSpeed = 1; // ACK后置为0
 153   2              motor.targetSpeedTemp += motor.speedChangeStep;
 154   2              LimitSpeed(&motor.targetSpeed, motor.minSpeed, motor.maxSpeed);
 155   2          }
 156   1      }
 157          
 158          /**
 159           * @description: 减速
 160           * @return {*}
 161           */
 162          void ReduceSpeed()
 163          {
 164   1          if (ui.modePage == SpeedPage)
 165   1          {
 166   2              // 只允许在速度设置页设置转速
 167   2              ui.isSetSpeed = 1; // ACK后置为0
 168   2              motor.targetSpeedTemp -= motor.speedChangeStep;
 169   2              LimitSpeed(&motor.targetSpeed, motor.minSpeed, motor.maxSpeed);
 170   2          }
 171   1      }
 172          
 173          /**
 174           * @description: UI刷新
 175           * @return {*}
 176           */
 177          void ModeUi()
C51 COMPILER V9.52.0.0   MYFUNCTION                                                        04/01/2023 22:13:42 PAGE 4   

 178          {
 179   1          static int flashCount = 0; // UI闪烁切换
 180   1      
 181   1          if (ui.isSetSpeed == 0)
 182   1          {
 183   2              // 当前不在转速设置页面,正常显示转速
 184   2              SetNumber1650(motor.targetSpeed);
 185   2          }
 186   1          else
 187   1          {
 188   2              // 当前为转速设置页面 闪烁提示
 189   2              flashCount++;
 190   2              if (flashCount % 10 == 0)
 191   2              {
 192   3                  flashCount = 0;
 193   3                  Clear1650();
 194   3              }
 195   2              else if (flashCount % 5 == 0)
 196   2              {
 197   3      
 198   3                  SetNumber1650(motor.targetSpeedTemp); // 显示的临时转速
 199   3              }
 200   2          }
 201   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    443    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =      7       8
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
   EDATA SIZE       =   ----    ----
   HDATA SIZE       =   ----    ----
   XDATA CONST SIZE =   ----    ----
   FAR CONST SIZE   =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
