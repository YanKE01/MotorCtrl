/**
 * @copyright (C) COPYRIGHT 2022 Fortiortech Shenzhen
 * @file      TimerInit.c
 * @author    Fortiortech  Appliction Team
 * @since     Create:2021-05-14
 * @date      Last modify:2022-07-14
 * @brief     This file contains Timer Initial function used for Motor Control.
 */ 
    
#include <FU68xx_2.h>
#include <Myproject.h>

/**
 * @brief      TIM0初始化配置
 */
void TIM0_Init(void)
{
}

/**
 * @brief      TIM1初始化配置
 */
void TIM1_Init(void)
{
}

/**
 * @brief      TIM2初始化配置
 */
void TIM2_Init(void)
{
}

/**
 * @brief      TIM3初始化配置
 */
void TIM3_Init(void)
{
    /*  -------------------------------------------------------------------------------------------------
        先停止计数，配置完寄存器后，最后启动计数
        -------------------------------------------------------------------------------------------------*/
    ClrBit(TIM3_CR1, T3EN);                                         // 0-停止计数；1-使能计数
      SetBit(PH_SEL, T3SEL);                                            //0-不连接到端口GP11；1-连接到端口GP11
//    ClrBit(PH_SEL, T3SEL);
    /*  -------------------------------------------------------------------------------------------------
        1、时钟分频设置(T2PSC)
        2、000:cpuclk(24MHz)             001:cpuclk/2^1(12MHz)   010:cpuclk/2^2(6MHz)    011:cpuclk/2^3(3MHz)
        3、100:cpuclk/2^4(1.5MHz)  101:cpuclk/2^5(750KHz)  110:cpuclk/2^6(375KHz)  111:cpuclk/2^7(187.5KHz)
        -------------------------------------------------------------------------------------------------*/
    SetReg(TIM3_CR0, T3PSC0 | T3PSC1 | T3PSC2, 0 );
    /*  -------------------------------------------------------------------------------------------------
        1、模式选择
        2、0-输入模式
        3、1-输出模式
        -------------------------------------------------------------------------------------------------*/
    ClrBit(TIM3_CR0, T3MOD);
    ClrBit(TIM3_CR0, T3OCM);
    /*  -------------------------------------------------------------------------------------------------
        1、滤波时间
        2、T3FE1/T3FE0 = 00-不滤波；            T3FE1/T3FE0 = 01-8个时钟周期
        3、T3FE1/T3FE0 = 10-16个时钟周期；T3FE1/T3FE0 = 11-32个时钟周期
        -------------------------------------------------------------------------------------------------*/
    SetReg(TIM3_CR1, T3FE1 | T3FE0, T3FE0);
    /*  -------------------------------------------------------------------------------------------------
        1、清除中断标志位
        2、禁止PWM周期检测中断使能
        3、使能计数器上溢中断使能
        -------------------------------------------------------------------------------------------------*/
    ClrBit(TIM3_CR1, T3IR | T3IF | T3IP);                           // 清除中断标志位
    SetBit(TIM3_CR1, T3IPE | T3IFE);                                // 输入有效边沿变化中断使能和基本计数器上溢使能
    /*  -------------------------------------------------------------------------------------------------
        1、定时器2中断优先级配置及芯片中断总使能
        2、PTIM31-PTIM30，中断优先级控制值从0-3依次表示优先级从最低到最高，共4级优化级控制
        3、EA,芯片中断总使能
        -------------------------------------------------------------------------------------------------*/
    PTIM31 = 0;
    PTIM30 = 1;                                                     // TIM2/3中断优先级别为2
    EA = 1;
    /*  -------------------------------------------------------------------------------------------------
        配置周期值、比较值、计数值
        -------------------------------------------------------------------------------------------------*/
    TIM3__CNTR = 0;
    TIM3__DR = 0;
    TIM3__ARR = 24000;
    /*-----------启动计数------------------------------------------------*/
    SetBit(TIM3_CR1, T3EN);                                         //使能计数器，启动计数
}

/**
 * @brief      TIM4初始化配置
 */
void TIM4_Init(void)
{
    /*  -------------------------------------------------------------------------------------------------
        先停止计数，配置完寄存器后，最后启动计数
        -------------------------------------------------------------------------------------------------*/
    ClrBit(TIM4_CR1, T4EN);                                         // 0 - 停止计数；1 - 使能计数
    SetBit(PH_SEL, T4SEL);                                          // 1 - P0.1作为Time4的输入输出
    //    ClrBit(PH_SEL, T4SEL);                                            // 0 - P0.1作为GPIO
    /*  -------------------------------------------------------------------------------------------------
        1、时钟分频设置(T4PSC)
        2、000:cpuclk(24MHz)       001:cpuclk/2^1(12MHz)   010:cpuclk/2^2(6MHz)    011:cpuclk/2^3(3MHz)
        3、100:cpuclk/2^4(1.5MHz)  101:cpuclk/2^5(750KHz)  110:cpuclk/2^6(375KHz)  111:cpuclk/2^7(187.5KHz)
        -------------------------------------------------------------------------------------------------*/
    SetReg(TIM4_CR0, T4PSC0 | T4PSC1 | T4PSC2,  T4PSC0 );
    /*  -------------------------------------------------------------------------------------------------
        1、TIM4_CR0：   输入输出模式选择
        2、T4MOD = 0 输入Timer模式
        3、T4MOD = 1 输出模式
        -------------------------------------------------------------------------------------------------*/
    SetBit(TIM4_CR0,T4MOD);
//    ClrBit(TIM4_CR0, T4MOD);
    /*  -------------------------------------------------------------------------------------------------
        1、输出模式        ：比较模式选择
        2、T4OCM = 0      TIM4__CNTR <= TIM4__DR 输出 “0”  TIM4__CNTR > TIM4__DR 输出 “1”
        3、T4OCM = 1      TIM4__CNTR <= TIM4__DR 输出 “1”  TIM4__CNTR > TIM4__DR 输出 “0”
    
        1、输入Timer模式   ：周期沿选择
        2、T4OCM = 0      相邻两个上升沿为1个周期，上升沿到下降沿为高电平脉宽
        3、T4OCM = 1      相邻两个下降沿为1个周期，下降沿到上升沿为低电平脉宽
        -------------------------------------------------------------------------------------------------*/
    //    SetBit(TIM4_CR0,T4OCM);//输出比较器匹配模式,TIM3_CNTR≤TIM3_DR: 0;
    ClrBit(TIM4_CR0, T4OCM);
    /*  -------------------------------------------------------------------------------------------------
        1、滤波时间
        2、00 - 不滤波；       01 - 8个时钟周期
        3、10 - 16个时钟周期； 11 - 32个时钟周期
        -------------------------------------------------------------------------------------------------*/
    SetReg(TIM4_CR1, T4FE1 | T4FE0, T4FE1 | T4FE0);
    /*  -------------------------------------------------------------------------------------------------
        1、清除中断标志位
        2、禁止PWM周期检测中断使能
        3、使能计数器上溢中断使能
        -------------------------------------------------------------------------------------------------*/
    ClrBit(TIM4_CR1, T4IR | T4IP | T4IF);                           // 清除中断标志位
    ClrBit(TIM4_CR1, T4IFE | T4IPE);                                // 输入有效边沿变化中断使能和基本计数器上溢使能
    ClrBit(TIM4_CR0, T4IRE);                                        // 輸出模式：比較匹配中斷使能  輸入模式：脈寬檢測中斷使能
    /*  -------------------------------------------------------------------------------------------------
        1、单次模式配置
        2、输出模式：计数器上溢事件
        3、输入模式：PWM周期检测或计数器上溢事件
        4、T4OPM = 0       发生上述事件时，计数器不停止
        5、T4OPM = 1       发生上述事件时，计数器停止(清除T4EN)
        -------------------------------------------------------------------------------------------------*/
    ClrBit(TIM4_CR0, T4OPM);
    /*  -------------------------------------------------------------------------------------------------
        1、定时器4中断优先级配置及芯片中断总使能
        2、PTIM4S1-PTIM4S0，中断优先级控制值从0-3依次表示优先级从最低到最高，共4级优化级控制
        3、EA,芯片中断总使能
        -------------------------------------------------------------------------------------------------*/
    PTIM4S1 = 1;
    PTIM4S0 = 0;                                                    // TIM4中断优先级别为2
    EA = 1;
    /*  -------------------------------------------------------------------------------------------------
        配置周期值、比较值、计数值
        -------------------------------------------------------------------------------------------------*/
    TIM4__DR   = 12000;                                             //输入模式，DR和ARR的值由硬件写；
    TIM4__ARR  = 24000.;
    TIM4__CNTR = 0;
    /* -----启动计数----- */
    SetBit(TIM4_CR1, T4EN);                                         //使能计数器，启动计数
}

/*  -------------------------------------------------------------------------------------------------
    Function Name  : TIM1ms_Init
    Description    : TIM1MS初始化配置
    Date           : 2020-08-07
    Parameter      : None
    ------------------------------------------------------------------------------------------------- */

void TIM1ms_Init(void)
{
    //SYST_ARR = 24000;                                             //计算公式：24M/SYST_ARR；例 24M/24000=1000Hz
    PTIM4S1 = 0;
    PTIM4S0 = 1;                                                    // TIM4/5中断优先级别为1
    EA = 1;
    SetBit(DRV_SR, SYSTIE);                                         // 使能1ms定时中断
}
